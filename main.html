<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Distance Service</title>
  <style>
    html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

    #map {
        flex-basis: 0;
        flex-grow: 4;
        height: 100%;
      }

    #container {
      display: flex;
      height: 100%;
    }

    #sidebar {
        flex-basis: 15rem;
        flex-grow: 1;
        padding: 1rem;
        max-width: 30rem;
        box-sizing: border-box;
        overflow: auto;
        flex-direction: column;
      }

    h3 {
      margin: 0 0 15px;
      font-size: 1.5rem;
      color: #333;
    }

    pre {
      overflow: auto;
      background-color: #f8f8f8;
      padding: 10px;
      border: 1px solid #ddd;
    }

    input {
      margin-bottom: 15px;
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    button {
      background-color: #4caf50;
      color: #fff;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }

    button:disabled {
      background-color: #ddd;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  
  <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
  <script async src="https://maps.googleapis.com/maps/api/js?key=PRIVATE_KEY&loading=async&libraries=places&callback=initMap"></script>
  <div id="container">
    <div id="sidebar">
      
      <h3>Response</h3>
      <pre id="response"></pre>
      <input type="file" id="csvFile" accept=".csv">
      <input type="text" placeholder="Destination" id="destination">
      <input type="number" id="maxDistance" placeholder="Enter maximum distance">
      <button onclick="processCSV()" id="processButton">Process CSV</button>
      <button id="downloadButton" onclick="downloadCSV()" disabled>Download Modified CSV</button>
    </div>
    <div id="map"></div>
  </div>
  
  
    <script>
     
      function initMap() {
        const map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 55.53, lng: 9.4 },
          zoom: 10,
        });
      }
    </script>

  
  <script>
      var options = { types: ['(cities)'] };

      window.onload = function () {
          var input1 = document.getElementById("destination");
          var autocomplete1 = new google.maps.places.Autocomplete(input1, options);
      };

  </script>
  <script>

      async function processCSV() {
        const csvFileInput = document.getElementById('csvFile');
        const destinationInput = document.getElementById('destination').value;
        const maxDistance = parseFloat(document.getElementById('maxDistance').value);

        console.log("destinationInput: " + destinationInput);
        console.log("maxDistance: " + maxDistance);

        const file = csvFileInput.files[0];
        if (!file) {
            alert('Please choose a CSV file.');
            return;
        }

        const reader = new FileReader();
        reader.onload = async function (e) {
            const csvContent = e.target.result;

            const lines = csvContent.split('\n');
            console.log("lines: " + lines);

            const modifiedCsv = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                console.log("line: " + line);

                if (i === 0) {
                    // Header row
                    modifiedCsv.push(line + ',Flag'); // Add "Flag" to the header
                } else if (line) {
                    const flag = await calculateDistance(line, destinationInput, maxDistance);
                    modifiedCsv.push(line + ',"' + flag + '"'); // Add flag value to each row
                }
            }

            // Display modified CSV
            document.getElementById('response').innerText = modifiedCsv.join('\n');

            // Enable the download button
            
            const downloadButton = document.getElementById('downloadButton');
            downloadButton.disabled = false;
        };

        reader.readAsText(file);
    }

    async function calculateDistance(location, destinationInput, maxDistance) {
        const service = new google.maps.DistanceMatrixService();
        const origins = [location];
        const destinations = [destinationInput];

        const request = {
            origins: origins,
            destinations: destinations,
            travelMode: google.maps.TravelMode.BICYCLING,
            unitSystem: google.maps.UnitSystem.METRIC,
            avoidHighways: false,
            avoidTolls: false,
        };

        return new Promise((resolve, reject) => {
            service.getDistanceMatrix(request, function (response, status) {
                if (status === 'OK' && response.rows.length > 0 && response.rows[0].elements.length > 0) {
                    const distance = response.rows[0].elements[0].distance.value / 1000; // Convert meters to kilometers
                    console.log("location: " + location);
                    console.log("Distance: " + distance + " km");

                    const flag = distance <= maxDistance ? 'YES' : 'NO';
                    console.log("flag: " + flag);
                    resolve(flag); // Resolve the promise with the flag value
                } else {
                    console.error('Error fetching distance matrix:', status);
                    reject(); // Reject the promise if there's an error
                }
            });
        });
    }

    function downloadCSV() {
    const content = document.getElementById('response').innerText;
    const filename = 'modified_data.csv';

    const blob = new Blob([content], { type: 'text/csv' });
    const link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    link.download = filename;
    link.click();
}

  </script>
</body>
</html>